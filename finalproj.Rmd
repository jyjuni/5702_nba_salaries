---
title: "finalproject"
author: "Shanzhao Qiao, Yijia Jin"
date: "11/6/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(GGally)
library(ggplot2)
library(dplyr)
library(tidyr)
library(prob)
library(hexbin)
library(tidyverse)
library(naniar)
library(patchwork)
library(ggcorrplot)
library(ggridges)
```

1. Introduction

How NBA teams decide the salaries of their players has awakened the curiosity of many scholars. Some investigators suggest that points per game and field goal percentage are the main contributors to players’ salaries (Lyons, Jackson, Livingston, 2015). However, other studies suggest that the common assumption that teams will determine the salary mainly based on offensive performance isn’t accurate. Instead, defensive performances such as rebounds are significant determinants of salary (Huang, 2016). Scholars also state that race is crucial in the determination of salary: U.S.-born African Americans tend to be paid more than U.S.-born Whites, and foreign players from a bigger country tend to be paid higher than those who are from a smaller country(Yang, Chih-Hai, and Hsuan-Yu Lin, 2010). While those experts argue about which factor affects each player’s salary, we believe that each player’s salary is determined by multiple predictors. 

In this project, we will use statistical visualization tools to visualize the correlation between those factors described above as well as the correlation between players' salary and the factors, by which we could recognize potential trends and causual relations within those numbers. After this project, we are expected to identify, with a more comprehensive scope, the factors that are influential in determining players' salary, which will serve as important supporting information for front offices in the NBA. Also, this project can allow fans to challenge or validate their assumptions about a player’s value and have a different perspective in understanding trades and free agency.


2. Data Description

We retrieved the data on player performance from https://www.basketball-reference.com/leagues/NBA_2021_advanced.html and retrieved the salary data from https://www.basketball-reference.com/contracts/players.html. Data from basketball-reference.com were retrieved from Sportradar, which is also the official stats partner of the NBA. Sportradar offers various scales of data collection systems, and most of times their data journalists would collect NBA data at a venue or from TV. Those collected data would then be uploaded, processed and distributed using different channels. The race data of players is collected from https://www.interbasket.net/news/what-percentage-of-nba-players-are-black-how-many-are-white/31018/. Note that there is no specific data of each player’s race in authoritative websites, but this link is a blog where the author collect the raw data directly from the NBA official website, and we scraped the link as our race data. We would double check players’ race as we are combining the two data sets. 
The salary would be the dependent variable, while other data, including performance, age, and race would be the independent variables, among which both numerical and categorical variables exist. After combining the two datasets, we had a dataset with 540 observations and
30 variables, including 1 dependent variable as salary and 29 independent variables. 

Notice that there is a discrepancy between the number of players in the performance data and race, as well as salary, data because the performance data were from the last season, while the race and salary data are from the list of current NBA players, so players that played in last season but not in this season would be assigned by N/A in their race and salary. 

3. Data Transformation

By using the Vlookup function in Excel, we first combined the performance data and salary data with the key of player_id, since the two datasets are from the same website and have same encoding of players' ids. Then we combined the race data we scraped with the previous manipulated dataset. First we concacenated the first and last name in the race dataset to form a column with players' names, and splited the Player column in the manipulated dataset with LEFT function to get a PlayName column without players' id, and use the Vlookup with respect to the key PlayerName. After we got all the necessary columns for our dataset, we changed the Salary column type from string into double, and we also changed all the "#N/A" in Race column into NAs that are recognizable by R. Thus, we have our dataset prepared to be analyzed. 

```{r,warning=FALSE}
nba <- read_csv("nba_1.csv")
nba$Salary <- as.numeric(nba$Salary)
nba <- nba %>% replace_with_na(replace = list(Race = "#N/A")) #%>% dplyr::filter(is.na(Race)==FALSE)
```

4. Missing Value

```{r, include=FALSE}
missplot <- function(mydata, percent=FALSE){
  missing_patterns <- data.frame(is.na(mydata)) %>%
    group_by_all() %>%
    count(name = "count", sort = TRUE) %>%
    ungroup()
  
  missing_patterns <- missing_patterns %>% rownames_to_column("id")
  
  missing_patterns_tidy <- missing_patterns %>%
    pivot_longer(-c(id,count), names_to = "key", values_to = "missing") %>% 
    group_by(id) %>% mutate(complete_cases = sum(missing) == 0)
  
  # main tile graph
  p1 <- missing_patterns_tidy %>%
    ggplot(aes(x = fct_reorder(key, -missing, sum), y = fct_rev(id), fill = missing)) +
    geom_tile(color = "white", aes(alpha = complete_cases, fill=missing)) +
    xlab("variable") +
    ylab("missing pattern") +
    scale_fill_manual(values= c("grey", "mediumpurple")) +
    scale_alpha_manual(values= c("FALSE"=0.7), guide = FALSE) +
    theme_bw() +
    theme(legend.position = "none", panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    theme(axis.text.x = element_text(angle = 90))
  
  
  # top graph count by category
  missing_rowcount <- mydata %>% summarise_all(~ sum(is.na(.))) %>% pivot_longer(everything(), names_to = c("variable"))
  p2 <-  missing_rowcount %>%
    ggplot(aes(x = fct_reorder(variable, -value), y = value)) +
    geom_bar(stat="identity", fill="cornflowerblue", alpha = 0.7)+
    ggtitle("Missing value patterns") +
    xlab("") +
    ylab("num rows \n missing") +
    theme_bw() +
    theme(panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank(),
          panel.grid.minor.y = element_blank()) + 
    scale_x_discrete(label=abbreviate) +
    theme(axis.text.x = element_text(angle = 90))
  
  # using the raw missing_patter dataframe, but add one column filter complete_cases 
  missing_patterns$complete_cases <- ifelse(rowSums(missing_patterns[sapply(missing_patterns, is.logical)]), F, T)
  
  # right graph count by patterns
  p3 <- missing_patterns %>% 
    ggplot(aes(x = fct_rev(id), y = count)) + 
    geom_bar(stat="identity", fill="cornflowerblue", aes(alpha = complete_cases)) +
    coord_flip() +
    xlab("") +
    ylab("row count") +
    scale_alpha_manual(values= c("FALSE"=0.7), guide = "none") +
    theme_bw() +
    theme(panel.grid.major.y = element_blank(),
          panel.grid.minor.y = element_blank()) + 
    scale_x_discrete(label=abbreviate)
  
  
  if(percent == TRUE){
    # top graph percent by rows
    missing_rowcount <- mydata %>% summarise_all(~ sum(is.na(.))/length(.)*100) %>% pivot_longer(everything(), names_to = c("variable"))
    p2 <-  missing_rowcount %>%
      ggplot(aes(x = fct_reorder(variable, -value), y = value)) + 
      geom_bar(stat="identity", fill="cornflowerblue", alpha = 0.7)+
      ylim(0,100) + 
      ggtitle("Missing value patterns") +
      xlab("") + 
      ylab("% row \n missing") + 
      theme_bw() + 
      theme(panel.grid.major.x = element_blank(),
            panel.grid.minor.x = element_blank(),
            panel.grid.minor.y = element_blank()) + 
      scale_x_discrete(label=abbreviate) +
    theme(axis.text.x = element_text(angle = 90))
    
    # using the raw missing_patter dataframe, but add one column filter complete_cases 
    missing_patterns$complete_cases <- ifelse(rowSums(missing_patterns[sapply(missing_patterns, is.logical)]), F, T)
    missing_patterns %>% dplyr::mutate(percentage = count/nrow(mydata)*100)
    
    # right graph count by patterns
    p3 <- ggplot(missing_patterns, aes(x = fct_rev(id), y = percentage)) + 
      geom_bar(stat="identity", fill="cornflowerblue", aes(alpha = complete_cases)) +
      coord_flip() +
      xlab("") +
      ylab("% row") + 
      ylim(0,100) + 
      scale_alpha_manual(values= c("FALSE"=0.7), guide = "none") +
      theme_bw() +
      theme(panel.grid.major.y = element_blank()) + 
      scale_x_discrete(label=abbreviate)
    
  }
  layout <- "
    BBBB#
    AAAAC
    AAAAC
    AAAAC
    AAAAC
    "
  p1 %+% p2 %+% p3 %+% 
    plot_layout(design = layout)
}

```

```{r}
# plt missing pattern
missplot(nba)
```

From the above missing value patterns plot with counts, it is noticed that there are only missing values in column Race with 150 rows, in column Salary with 115 rows, and in columns 3PAr, FTr, and TS%, with only 1 row. The main missing pattern plot shows that there are only 5 patterns: complete, missing in Race, missing in Salary, missing in Race and Salary, and missing in Race, Salary, FTr, TS%, and 3PAr. As mentioned in the data description part, the way our data set is collected could result in the missing pattern. The reason is that the performance data were from the last season, while the race and salary data are from the list of current NBA players, so players that played in last season but not in this season would be assigned by N/A in their race and salary. There is only one row of missing values in the performance data, which is a good sign considering that performance is the more influential factor in deciding players' salary, and we will only analyze the rows with complete performance data in the seek of comprehension. 


```{r}
nba %>% dplyr::filter(is.na(Race)==TRUE|is.na(Salary)==TRUE) %>% 
        ggplot(aes(x = WS)) + 
        geom_histogram(fill = "white", colour = "black", binwidth = 1) + 
        ggtitle("Distribution of Win Share of Players with Missing Race Data or Salary Data") + 
        xlab("Win Share")
```

```{r}
nba %>% dplyr::filter(is.na(Race)==TRUE|is.na(Salary)==TRUE) %>% 
        ggplot(aes(x = Age)) + 
        geom_histogram(fill = "white", colour = "black", binwidth = 1) + 
        ggtitle("Distribution of Age of Players with Missing Race Data or Salary Data") + 
        xlab("Age")
```


It is noticed that there are missing values in the race and salary columns. We are curious about the pattern among those missing values.

From the way that the race data is collected, which is described as the discrepancy in the data description section, we know that players that whether retired or were fired has missing values in their races and salary, so we looked into the win share and age of those players. Win Shares is a player statistic which attempts to divvy up credit for team success to the individuals on the team. From the plot above, it is noticed that most players with missing race data has very low win shares that are closed to 0, which correspond to the fact that they were probably fired because of their poor contribution to the team in the last season. Also, a few players with missing values have high ages values, which is a signal of retirement. 

5. Exploratory Analysis

```{r}
df <- nba %>% drop_na()
```
By the missing pattern above, we decide to drop all the players with missing values since we only want to consider those active players in the NBA league this year so that we could give a prediction for next season, and the players with missing values are either retired players or no longer playing in the NBA league. 

## Categorical Data

First of all, we are going to explore within the categorical variables. The first categorical variable we care about is Tm, which represents which team a player belongs to.

```{r, warning=FALSE}
df %>% ggplot(aes(x = Salary, y = reorder(Tm, Salary, FUN = mean))) +
  geom_density_ridges(scale = 3)
```

From the ridge plot above, it is noticed that most teams in the league have a bi-cluster distribution of players' salary in the team, because there are salary caps in the league, so team managers have to distribute the total salary wisely instead of hiring all top players in the league. In fact, the bi-cluster is because in each team, there are a few great players with high salary, but there must be some players that are paid less because of the salary cap. 

Overally , the three teams that tend to pay players highest salary are Houston Rocket, Milwaukee Bucks, and Denver Nuggets. 

Then the categorical variables left are race and position. However, we decide to include players' age in this part by binning the numeric variable Age into four bins, which is shown below. In this way we have analyzed all off-court factors, i.e. factors other than players' performance on court. By plotting the overall categorical distribution, it is noticd that more than 80% of players in the NBA league are black or mixed and are in an interval of age between 23 and 35. Also, players are roughly even-distributed in positon, which makes sense because every position shares similar necessity and importance in each team. No team could play with five centers or five point guards on court. 

```{r}
# # multivariate separate barplot (14-2): overall categorical distribution
# df %>% ggplot(aes(x = Age)) + 
#         geom_histogram(fill = "white", colour = "black", binwidth = 1) + 
#         ggtitle("Distribution of Age of Players") + 
#         xlab("Age")
library(mltools)



# df[, c("Age_group","Pos","Race", "Salary")] %>%
#   pivot_longer(-c(Salary), names_to = "Property", values_to = "Value") %>%
# # df[, c("Age_group","Tm","Pos","Race", "Salary")] %>%
# #   mutate(count = n()) %>%
# #   group_by(Age_group) %>% 
# #   mutate(c = n(), prop_age = c / count) %>% 
# #   ungroup()
#   ggplot(aes(x = Property, y = Value)) +
#   geom_density()



# age binned: 23-, 23-28, 29-34, 35+
df$Age_group <- bin_data(df$Age, bins=c(-Inf, 23, 28, 35, Inf), boundaryType = "lcro]")
n <- c("Age_group","Pos","Race")        

df_age <- dplyr::count(df, get("Age_group")) %>% rename(Category = `get("Age_group")`) %>%  mutate(prop = n/sum(n))
df_age$Type = "Age"

df_pos <- dplyr::count(df, get("Pos")) %>% rename(Category = `get("Pos")`) %>%  mutate(prop = n/sum(n))
df_pos$Type = "Pos"

df_race <- dplyr::count(df, get("Race")) %>% rename(Category = `get("Race")`) %>%  mutate(prop = n/sum(n))
df_race$Type = "Race"

df_summary <- rbind(df_age, df_pos, df_race)  %>% group_by(Type) %>% 
  arrange(desc(n), .by_group = TRUE) %>% ungroup() %>% mutate(Category=factor(Category, levels=Category)) 

df_summary %>% 
  ggplot(aes(x = Category, y = prop, fill=Type)) +
  geom_bar(stat="identity", position="dodge") +
  geom_text(label=round(df_summary$prop, digits=3), hjust= -0.15, size=2) +
    coord_flip() +
    ylab("Frequency by Percentage") + 
    xlab("Category") + 
    ggtitle("Distribution of Categorical Variables") +

    theme_classic()



```

By looking closer into the distibution of salary in each race, it is notived that the distributions share similar range and shape, which means that the NBA league and teams in the league have no preference of race, and race is not an influential factor in deciding players' salary. 

```{r}
df %>% ggplot(aes(x=Salary, y=reorder(Race, Salary, FUN = median))) + 
        geom_boxplot() + 
        ylab('Race') + 
        ggtitle("Boxplot of Salary in Each Race")
```

Then we will analyze the effect of age and position. 

```{r}
# quantile(df$Salary, c(.05, .25, .5, .75, .95)) 

df$Salary_level <- bin_data(df$Salary, bins=c(0, .05, .25, .5, .75, .95, 1), binType="quantile", boundaryType = "lcro]")
df$G_level <- bin_data(df$G, bins=5, boundaryType = "lcro]")
df$MP_level <- bin_data(df$MP, bins=5, boundaryType = "lcro]")
df$PER_level <- bin_data(df$PER, bins=5, boundaryType = "lcro]")


```

```{r}
# alluvial graph
library(ggalluvial)

# library(ggalluvial)
# ggplot(as.data.frame(UCBAdmissions),
# aes(y = Freq, axis1 = Gender, axis2 = Dept, axis3 = Admit)) +
# geom_alluvium(aes(fill = Gender), width = 1/12) +
# geom_stratum(width = 1/12, fill = "grey80", color = "grey") +
# geom_label(stat = "stratum",
# aes(label = after_stat(stratum))) +
# scale_x_discrete(expand = c(.05, .05)) +
# scale_fill_brewer(type = "qual", palette = "Set1") +
# ggtitle("UC Berkeley admissions and rejections") +
# theme_void()

df_select <- df[, c("Age_group","Tm","Pos", "Race", "Salary_level")]
df_select <- df_select %>% group_by(Pos, Age_group, Salary_level) %>%  summarize(Freq = n())
ggplot(as.data.frame(df_select), aes(y = Freq, axis1=Pos, axis2 = Age_group, axis3=Salary_level)) +
  geom_alluvium(aes(fill=Salary_level), stat = "alluvium") + 
  geom_stratum(width = 1/12, fill = "grey80", color = "grey") +
  geom_label(stat = "stratum",aes(label = after_stat(stratum))) +
  scale_x_discrete(expand = c(.05, .05))
## exp:

# |------>|------->|-------------->|------------>|----------->|--------------->|
# team   pos    age(binned)    G(binned)   MP(binned)  PER(binned)   salary(binned)
# |------>|------->|-------------->|------------>|----------->|--------------->|
# color by salary bins

```

From the alluvial graph above, we noticed that there is no strong correaltion between position and salary level because, as we disscussed above, all positions are important in a team. For the relationship between age and salary level, we can not conclude that the older the player the higher the salary would be, but most players younger than 23 has lowest salary level while most players with highest salary level are above 28 years old. The reason is that young players who just enter the league still need a long time span to show their performance to the team managers and the agencies to be qualified for high salary. However, older players have already built up their profiles among managers and agencies with years of experiences and performaces, and teams tend to pay older players higher because they are not only experienced players that could benefit the whole team on court but also good leaders that could teach and encourage younger players in the team off court. 

## Numeric Data

First, we plot a parallel coordinates in order to view the general trend of player's performance with different levels of salary. It is noticed that most players' performance data follow a general trend even with different levels of salary, and the pattern is obvious. Therefore, we are more confident that our result could be applied to the whole league instead of only a few teams or players. 
```{r}
library(GGally)
df <- df %>% mutate(MPG=MP/G)
# cols = c('Age', 'G', 'MP', 'MPG', "PER","TS%","3PAr","FTr","ORB%","DRB%","TRB%","AST%","STL%","BLK%","TOV%","USG%" ,"OWS","DWS","WS","WS/48","OBPM","DBPM","BPM","VORP","Salary" )
cols = c('Age', 'G', 'MP', 'MPG', "PER","WS","OBPM","DBPM","BPM","VORP","Salary" ,"Salary_level")
df[,cols] %>% 
  GGally::ggparcoord(alphaLines = 0.25, 
                     scale = "uniminmax",
                     splineFactor = 10,
                     groupColumn = "Salary_level"
                    ) + 
    xlab("categories") + ylab("cases") + 
    ggtitle("NBA players' Performance") + 
    theme(legend.position = "bottom", axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

Then we explore the correlation between those numeric factors, which is shown below. 

```{r}
df_dbl <- df %>% select_if(is.numeric) %>% select(-'Rk')


corr <- round(cor(df_dbl), 1)
ggcorrplot(corr, type = "lower",
   outline.col = "white",
   ggtheme = ggplot2::theme_gray,
   colors = c("#6D9EC1", "white", "#E46726"))
```

From the correlation matrix, we are able to identify a few factors that are more correlated to players' salary than other factors, which are VORP, OBPM, WS, OWS, USG%, and AST%. However, among those factors, WS and OWS are strongly correalted, which is the reason that winshare is calculated with respect to offensiv win share, OWS here, and defensive winshare, so we would exclude OWS here. The top five factors that are most correlated to the salary is: 

VORP(Value Over Replacement Player): the marginal utility of a player. 
OBPM(Offensive Box Plus/Minus): the overall contribution to the team's offense round. 
WS(Win Share): individual's credit to team success. 
USG%(Usage Rate): the percentage of team plays the player. 
AST%(Assist Percentage): the percentage of made shots by teammates were assisted by the player.

```{r}

# scatterplot (11): 1. choose a few most imortant factor of theory to scatterplot
## y: salary 
## x: {VORP, OBPM, WS, USG%, AST%} 

# VORP with bin counts
gVORP <- df %>% ggplot(aes(VORP, Salary)) +
    geom_point(color = "blue", alpha = .5) + 
    geom_smooth(method = "lm", se=FALSE, colour="red", fullrange=TRUE, size=0.5) +
  scale_fill_gradient(low = "#dddddd", high = "#09005F") + 
  theme_classic()

# OBPM
gOBPM <- df %>% ggplot(aes(OBPM, Salary)) +
    geom_point(color = "blue", alpha = .5) + 
    geom_smooth(method = "lm", se=FALSE, colour="red", fullrange=TRUE, size=0.5) +
  scale_fill_gradient(low = "#dddddd", high = "#09005F") + 
  theme_classic()

# WS
gWS <- df %>% ggplot(aes(WS, Salary)) +
    geom_point(color = "blue", alpha = .5) + 
    geom_smooth(method = "lm", se=FALSE, colour="red", fullrange=TRUE, size=0.5) +
    theme_classic()
# USG%
gUSG <- df %>% ggplot(aes(`USG%`, Salary)) +
    geom_point(color = "blue", alpha = .5) + 
    geom_smooth(method = "lm", se=FALSE, colour="red", fullrange=TRUE, size=0.5) +
    theme_classic()

# AST%
gAST <- df %>% ggplot(aes(`AST%`, Salary)) +
    geom_point(color = "blue", alpha = .5) + 
    geom_smooth(method = "lm", se=FALSE, colour="red", fullrange=TRUE, size=0.5) +
    theme_classic()

gridExtra::grid.arrange(gVORP, gOBPM, gWS, gUSG, gAST,  nrow = 3)

```

It is noticed that the scatterplots above all present a positive correaltion between players' performance and salary, which means that the more VORP(OBPM, WS, USG%, AST%) one has, the higher salary he is likely to get. And the five factors measuring players' performance on court could be significant factors for managers and agencies to consider when deciding players' salary. 

Among those significant factors, we are curious about whether there is an obvious pattern in the distribution of those factors with respect to the categorical factors, namely age, team, race, and position. We would choose the factor that is most correlated to the salary and the most recognized factor measuring players' performance to explore, the VORP(Value Over Replacement Player). 

## Combine Continuous Factors With Categorical Factors

```{r}
# 2. add color: choose a few (less) possible factors
## for each scatterplot, add one variable at a time (12-8)
## color: {age, team, race, position}

gAge <- df %>% ggplot(aes(VORP, Salary)) +
    geom_point(aes(color = Age_group)) + 
    geom_smooth(method = "lm", se=FALSE, colour="red", fullrange=TRUE, size=0.5) +
    theme_classic()
gTm <- df %>% ggplot(aes(VORP, Salary)) +
    geom_point(aes(color = Tm)) +  
    geom_smooth(method = "lm", se=FALSE, colour="red", fullrange=TRUE, size=0.5) +
    theme_classic()
gPos <- df %>% ggplot(aes(VORP, Salary)) +
    geom_point(aes(color = Pos)) + 
    geom_smooth(method = "lm", se=FALSE, colour="red", fullrange=TRUE, size=0.5) +
    theme_classic()
gRace <- df %>% ggplot(aes(VORP, Salary)) +
    geom_point(aes(color = Race)) + 
    geom_smooth(method = "lm", se=FALSE, colour="red", fullrange=TRUE, size=0.5) +
    theme_classic()
gridExtra::grid.arrange(gAge, gTm, gPos, gRace, nrow = 2)
```

Note that there is no obvious pattern in the distribution of VORP with respect to the categorical variables other than the fact we have already discussed in the categorical factor part, which again demonstrate that the NBA league is a place where players in all ages, all races, all positions, and all teams are treated fairly and could be thrifty both on performance on court and on wealth off court. 

### geographic patterns
assumption: geographic should affect? common guess: west coast team / larger cities pays higher
```{r}
#import and merge  state stata
team_abbrev <- read_csv("team_abbrev.csv")
team_state <- read_csv("team_states.csv")
df_team <- merge(x = team_abbrev, y = team_state, by = "Team", all.x = TRUE)
df_states <- merge(x = df, y = df_team, by.x = "Tm", by.y = "Abbr")
sum(is.na(df_states))

df_states_means <- df_states %>% as.data.frame()  %>% group_by(States) %>% summarize(Mean_Salary = mean(Salary))
team_count <- read_csv("states_teamcounts.csv")
df_states_means <- merge(x = team_count, y = df_states_means, by = "States", all = TRUE)


df_states_median <- df_states %>% as.data.frame()  %>% group_by(States) %>% summarize(Mean_Salary = median(Salary))
df_states_median <- merge(x = team_count, y = df_states_median, by = "States", all = TRUE)

df_states_max <- df_states %>% as.data.frame()  %>% group_by(States) %>% summarize(Mean_Salary = max(Salary))
df_states_max <- merge(x = team_count, y = df_states_max, by = "States", all = TRUE)


df_states_min <- df_states %>% as.data.frame()  %>% group_by(States) %>% summarize(Mean_Salary = min(Salary))
df_states_min <- merge(x = team_count, y = df_states_min, by = "States", all = TRUE)
```
```{r, warning=FALSE}
library(statebins)

# Note: direction = 1 switches the order of the fill scale 
# so darker shades represent higher illiteracy rates
# (The default is -1).

gMedian <- statebins(df_states_median, state_col = "States" , value_col="Mean_Salary",
          name = "median salary", direction = 1, na_label = "white") +
  ggtitle("State Median NBA Salary Rates") +
  theme_statebins(base_size = 5)

gMax <- statebins(df_states_max, state_col = "States" , value_col="Mean_Salary",
          name = "maximum salary", direction = 1, na_label = "white") +
  ggtitle("State Max NBA Salary Rates") +
  theme_statebins(base_size = 5)

gridExtra::grid.arrange(gMedian, gMax, nrow = 1)

```

By plotting the geographic plot, we could visualize the salary with respect to the state scale in the US. We chose to only inlcude the median and maximum of salary because we believe that the two measurement are suitable for general players and all stars players respectively. For the median, the three state with highest median of salary is LA, UT, and CO, with NBA team New Orleans Pelicans(LA), Utah Jazz(UT), and Denver Nuggets(CO), which are teams to consider for general players because they are more likely to get paid higher than other teams. For the maximum, the three state with highest maximum of salary is CA, TX, and OR, with NBA team Golden State Warriors(CA), Los Angeles Clippers(CA), Los Angeles Lakers(CA), Sacramento Kings(CA), Dallas Mavericks(TX), Houston Rockets(TX), San Antonio Spurs(TX), 	and Portland Trail Blazers(OR). By looking back to the distribution of salarys with facet on teams, it is noticed that Golden State Warriors(CA), Los Angeles Clippers(CA), Los Angeles Lakers(CA), and Houston Rockets(TX) are good options for all star players because those teams could accept super contract with extremely high salary. 


## Export Data for Part 6
```{r}
# calculate salary for each age per state
df_states_age_median <- df_states %>% as.data.frame()  %>% group_by(States,Age) %>% summarize(Mean_Salary = median(Salary))
df_states_age_max <- df_states %>% as.data.frame()  %>% group_by(States,Age) %>% summarize(Mean_Salary = max(Salary))

write.csv(df_states_median,"states_median.csv", row.names = FALSE)
write.csv(df_states_median,"states_max.csv", row.names = FALSE)
write.csv(df_states_age_median,"states_age_median.csv", row.names = FALSE)
write.csv(df_states_age_max,"states_age_max.csv", row.names = FALSE)
```

6. Interactive plot: 

# Interactive component

Try placing your mouse over a state...

<script src="https://d3js.org/d3.v7.js"></script>
  <div class="map-container"></div>
<script src="https://raw.githubusercontent.com/jyjuni/5702_nba_salaries/main/docs/square-map.js"></script>

```
# Note:
# We tried to add smooth transition for line plots, but we met some technical difficulties when new data points are added. Since the age data are of varied length for each state, when the sequence lenghth change(especially when it increases), the added part is first appended to the plot, and then starts the transition. Thus, the line sometimes "squeezes" during transition. We searched online for a solution, but found no answers related to this problem. We apologize for this "glitch". If you know the solution, please help us improve!
```
